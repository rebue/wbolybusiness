<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wboly.wechat.dao.order.WeChatUserAppraisalMapper">
	<!-- 修改用户评价状态 -->
	<update id="updateUserAppraiseState" parameterType="java.util.Map">
		UPDATE vbl_market_order_data.dbo.vbl_shop_order_inventory SET appraiseState=${appraiseState}
		WHERE orderId=${orderId} AND goodsId=${goodsId} AND skuId=${skuId} AND supplierUid=${supplierUid}
	</update>

	<!-- 添加用户评价图片 -->
	<insert id="insertUserAppraiseImg" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_appraise_img ( img ) VALUES ( '${img}' )
	</insert>

	<!-- 查询用户评价图片编号 -->
	<select id="selectUserAppraiseImgId" parameterType="java.util.Map" resultType="int">
		SELECT id FROM vbl_market_order_data.dbo.vbl_shop_order_appraise_img WITH(NOLOCK) WHERE img='${img}'
	</select>

	<!-- 添加评价信息 -->
	<insert id="insertVblShopOrderAppraiseData" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_appraise (
		activityId, shopId, goodsId, buyerUid, content, imgId, babyevaluation,
		logiSticsService, sellerService, replyMessage, appraiseState, dateline)
		VALUES ( ${activityId}, ${shopId}, ${goodsId}, ${buyerUid},
		'${content}', '${imgId}', ${babyEvaluation}, ${logiSticsService},
		${sellerService}, '', ${appraiseState}<!-- 1=追加评价 2=评价结束 -->, ${dateline} )
	</insert>

	<!-- 查询累积评价数 -->
	<select id="selectGoodsTotalAppraiseNumber" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * FROM vbl_market_goods_data.dbo.vbl_goods_stat WITH(NOLOCK) WHERE goodsId=${goodsId}
	</select>

	<!-- 增加累积评价数 -->
	<insert id="insertGoodsTotalAppraiseNumber" parameterType="java.util.Map">
		INSERT vbl_market_goods_data.dbo.vbl_goods_stat ( goodsId, evalNum, hits, salesVolume )
		VALUES ( ${goodsId}, 1, 0, 0 )
	</insert>

	<!-- 修改累计评价数 -->
	<update id="updateGoodsTotalAppraiseNumber" parameterType="java.util.Map">
		UPDATE vbl_market_goods_data.dbo.vbl_goods_stat SET evalNum = evalNum + 1 WHERE goodsId=${goodsId}
	</update>

</mapper>
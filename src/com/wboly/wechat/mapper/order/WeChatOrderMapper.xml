<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wboly.wechat.dao.order.WeChatOrderMapper">

	<!-- 根据活动编号以及买家编号查询用户是否购买过该规则商品 -->
	<select id="selectGoodsRuleLog" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * FROM vbl_market_goods_data.dbo.vbl_goods_rule_log WITH (nolock)
		WHERE 1 = 1 AND buyerUid = #{buyerUid} AND activityId = #{activityId}
	</select>

	<!-- 根据消费者以及订单号查询订单详情信息 -->
	<select id="selectOrderInventoryByParm" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT va.activityId,a2.* FROM (
			SELECT vsoi.goodsId, vsoi.skuId, vsoi.supplierUid, vsoi.num, vsoi.retailPrice, 
				vsoi.goodsTitle, vsoi.retailBacLimit, a.* FROM (
				SELECT orderId, shopId, buyerUid, message, addressId,
				CONVERT(DECIMAL(18,2),CAST(ISNULL(money, 0) AS DECIMAL)/100) AS money
				FROM vbl_market_order_data.dbo.vbl_shop_order WITH (NOLOCK)
				WHERE 1 = 1
				<if test="orderId != null and orderId !=''">
					AND orderId=#{orderId}
				</if>
				<if test="buyerUid != null and buyerUid !=''">
					AND buyerUid=#{buyerUid}
				</if>
				AND cancelType = 0 AND state IN(0,1)
			) a
			LEFT JOIN vbl_market_order_data.dbo.vbl_shop_order_inventory vsoi WITH (NOLOCK) ON a.orderId = vsoi.orderId AND a.buyerUid = vsoi.buyerUid
		) a2
		LEFT JOIN vbl_market_goods_data.dbo.vbl_activity va WITH(nolock) ON va.skuId=a2.skuId AND va.supplierUid=a2.supplierUid AND va.goodsId=a2.goodsId AND va.shopId=a2.shopId
	</select>

	<!-- 查询商品订单详情 -->
	<select id="selectOrderInventoryData" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT goodsId, goodsTitle, skuId, supplierUid, num, retailPrice, retailBacLimit 
		FROM vbl_market_order_data.dbo.vbl_shop_order_inventory WITH(NOLOCK)
		WHERE
		<if test="buyerUid != null and buyerUid != '' ">
			buyerUid=${buyerUid}
		</if>
		<if test="orderId != null and orderId != '' ">
			AND orderId=${orderId}
		</if>
	</select>

	<!-- 修改门店订单信息开始 -->
	<!-- 获取门店编号、消费用户编号 -->
	<select id="selectShopAndBuyer" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT shopId, buyerUid, money, courierFee, payType 
		FROM vbl_market_order_data.dbo.vbl_shop_order WITH(NOLOCK)
		WHERE
		<if test="orderId != null and orderId != '' ">
			orderId=${orderId}
		</if>
	</select>

	<!-- 更新门店交易订单支付方式、状态为代配送状态 -->
	<update id="updateShopOrderStatus" parameterType="java.util.Map">
		UPDATE vbl_market_order_data.dbo.vbl_shop_order SET payType=${payType}, state=1 <!-- 1=待配送 -->
		WHERE orderId=${orderId} AND state=0 <!-- 0=待支付 --> AND cancelType=0 <!-- 0=未取消 -->
	</update>

	<!-- 添加信息到门店交易订单付款信息表 -->
	<insert id="insertShopTransactionPaymentInfo" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_trade ( orderId,
		shopId, goodsId, skuId, barcode, buyerUid, supplierUid, num, money,
		retailPrice, leastBacLimit, retailBacLimit, price, payType, dateline )
		SELECT orderId, 1, goodsId, skuId, barcode, buyerUid, supplierUid, num,
		retailPrice * num, retailPrice, leastBacLimit, retailBacLimit, price, ${payType}, ${dateline} 
		FROM vbl_market_order_data.dbo.vbl_shop_order_inventory a WITH(NOLOCK) WHERE a.orderId=${orderId}
	</insert>

	<!-- 添加门店交易订单状态跟踪信息 -->
	<insert id="insertVblShopOrderTradeRecord" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_trade_record ( orderId, buyerUid, userId, userName, message, dateline )
		VALUES ( ${orderId}, ${buyerUid}, ${userid}, '${userName}', '${describe}', ${dateline} )
	</insert>

	<!-- 添加信息到订单返款计划表 -->
	<insert id="insertVblShopOrderPlantorefund" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_plantorefund (
		orderId, shopId, goodsId, skuId, buyerUid, supplierUid, num, price,
		retailPrice, leastBacLimit, retailBacLimit, sumretailBacLimit, status,
		ptype, dateline, rebatesDate )
		SELECT orderId, shopId, goodsId, skuId, buyerUid, supplierUid, num, price, retailPrice, leastBacLimit,
		retailBacLimit, retailBacLimit * num, 1<!-- 待执行 --> , 0<!-- 没有快递 --> , ${dateline}, ${dateline} + 300 <!-- * 24 * 3天后 -->
		FROM vbl_market_order_data.dbo.vbl_shop_order_trade WITH ( NOLOCK )
		WHERE
		<if test="orderId != null and orderId != '' ">
			orderId=${orderId}
		</if>
	</insert>

	<!-- 添加快递费（如果有） -->
	<insert id="insertExpressFeeVblShopOrderPlantorefund" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_plantorefund (
		orderId, shopId, goodsId, skuId, buyerUid, supplierUid, num, price,
		retailPrice, leastBacLimit, retailBacLimit, sumretailBacLimit, status, ptype, dateline, rebatesDate )
		VALUES ( ${orderId}, ${shopId}, 0, 0, ${buyerUid}, 0, 0, 0, 0, 0, 0, ${courierFee}, 1 <!-- 待执行 -->, 
		1<!-- 有快递费 --> , ${dateline}, ${dateline} + 3600 * 24 * 3 <!-- 3天后 -->)
	</insert>

	<!-- 添加推送消息计划 -->
	<insert id="insertVblPushPlan" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_push_plan ( userId,
		pushType, accepterId, title, message, recordTime )
		VALUES ( ${userid}, 1 <!-- 1=订单 -->, ${buyerUid}, '${pushContent}', '${describe}', ${dateline} )
	</insert>

	<!-- 更新vbl_goods销量 -->
	<update id="updateVblGoodsSales" parameterType="java.util.Map">
		UPDATE ta SET ta.saleNum = ta.saleNum + tb.num FROM vbl_market_goods_data.dbo.vbl_goods ta
		RIGHT JOIN vbl_market_order_data.dbo.vbl_shop_order_trade tb WITH ( NOLOCK ) ON ta.goodsId =tb.goodsId
		WHERE
		<if test="orderId != null and orderId != '' ">
			tb.orderId=${orderId}
		</if>
	</update>

	<!-- 更新vbl_goods_stat销量 -->
	<update id="updateVblGoodsStatSales" parameterType="java.util.Map">
		UPDATE ta SET ta.salesVolume = ta.salesVolume + tb.num FROM vbl_market_goods_data.dbo.vbl_goods_stat ta
		RIGHT JOIN vbl_market_order_data.dbo.vbl_shop_order_trade tb WITH ( NOLOCK ) ON ta.goodsId =tb.goodsId
		WHERE
		<if test="orderId != null and orderId != '' ">
			tb.orderId=${orderId}
		</if>
	</update>

	<!-- 更新vbl_activity销量 -->
	<update id="updateVblActivitySales" parameterType="java.util.Map">
		UPDATE ta SET ta.saleNum = ta.saleNum + tb.num FROM vbl_market_goods_data.dbo.vbl_activity ta
		RIGHT JOIN vbl_market_order_data.dbo.vbl_shop_order_trade tb WITH ( NOLOCK ) ON
		tb.shopId = ta.shopId AND ta.goodsId =tb.goodsId AND tb.skuId = ta.skuId AND tb.supplierUid = ta.supplierUid
		WHERE
		<if test="orderId != null and orderId != '' ">
			tb.orderId=${orderId}
		</if>
	</update>

	<!-- 更新vbl_activity_off销量 -->
	<update id="updateVblActivityOff" parameterType="java.util.Map">
		UPDATE ta SET ta.saleNum = ta.saleNum + tb.num FROM vbl_market_goods_data.dbo.vbl_activity_off ta
		RIGHT JOIN vbl_market_order_data.dbo.vbl_shop_order_trade tb WITH ( NOLOCK ) ON
		tb.shopId = ta.shopId AND ta.goodsId =tb.goodsId AND tb.skuId = ta.skuId AND tb.supplierUid = ta.supplierUid
		WHERE
		<if test="orderId != null and orderId != '' ">
			tb.orderId=${orderId}
		</if>
	</update>
	<!-- 门店修改订单状态结束 -->

	<!-- 用户评价开始 -->

</mapper>
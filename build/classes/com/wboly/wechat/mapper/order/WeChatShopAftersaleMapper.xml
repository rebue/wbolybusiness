<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wboly.wechat.dao.order.WeChatShopAftersaleMapper">
	<!-- 获取订单号、门店编号、商品编号、商品Sku编号 -->
	<select id="selectOrderStateAndBuyer" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT state, buyerUid, shopId FROM vbl_market_order_data.dbo.vbl_shop_order WITH(NOLOCK) 
		WHERE orderId=${orderId}
	</select>

	<!-- 查询售后状态 0:可以售后 1 进行中 2 结束 评价状态 0：待评价；1：追加评价；2：评价结束 -->
	<select id="selectOrderState" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT aftersaleState, appraiseState FROM vbl_market_order_data.dbo.vbl_shop_order_inventory WITH(NOLOCK)
		WHERE orderId=${orderId} AND goodsId=${goodsId} AND skuId=${skuId} AND supplierUid=${supplierUid}
	</select>

	<!-- 更新订单状态为售后状态 -->
	<update id="updateOrderStatusToBeAftersales" parameterType="java.util.Map">
		UPDATE vbl_market_order_data.dbo.vbl_shop_order
		SET state = 7 WHERE orderId = ${orderId} AND state = 4
	</update>

	<!-- 检查订单是否存在未处理完的售后(state:0.待处理;1.已回应;2:已关闭;3:处理完毕。) -->
	<select id="checkWhetherThereIsAnUnfinishedAftersaleOrde" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * FROM vbl_market_order_data.dbo.vbl_shop_order_aftersale WITH ( NOLOCK )
		WHERE orderId = ${orderId} AND state IN ( 0, 1 )
	</select>

	<!-- 根据商品活动编号获取门店编号、商品编号、商品Sku编号、供应商用户编号 -->
	<select id="selectShopGoodsSkuAndSupplierToActivityId" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT shopId, goodsId, skuId, supplierUid FROM vbl_market_goods_data.dbo.vbl_activity WITH(NOLOCK)
		WHERE activityId=${activityId} AND shopId=${shopId}
	</select>

	<!-- 添加用户售后图片 -->
	<insert id="insertUserAftersaleImg" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_aftersale_img ( img ) VALUES ( '${img}' )
	</insert>

	<!-- 查询用户已添加的售后图片编号 -->
	<select id="selectHaveBeenAddedAftersaleImgId" parameterType="java.util.Map" resultType="int">
		SELECT id FROM vbl_market_order_data.dbo.vbl_shop_order_aftersale_img WITH(NOLOCK) WHERE img = '${img}'
	</select>

	<!-- 添加用户申请售后信息 -->
	<insert id="insertVblShopOrderAftersaleData" parameterType="java.util.Map">
		INSERT INTO vbl_market_order_data.dbo.vbl_shop_order_aftersale (
		orderId, activityId, shopId, goodsId, skuId, buyerUid, supplierUid, aftersale, 
		imgId, appealType, state, result, managerId, buyerContact, createTime, entTime )
		VALUES ( ${orderId}, ${activityId}, ${shopId}, ${goodsId}, ${skuId}, ${buyerUid}, ${supplierUid},
		'${aftersale}', ${imgId}, ${appealType}, 0 <!-- 0.待处理 -->, ' ', 0, ${buyerContact}, ${dateline}, 0 )
	</insert>

	<!-- 更新门店交易订单清单信息售后状态 -->
	<update id="updateShopTransactionOrderInventoryState" parameterType="java.util.Map">
		UPDATE vbl_market_order_data.dbo.vbl_shop_order_inventory SET aftersaleState=1
		WHERE orderId=${orderId} AND goodsId=${goodsId} AND skuId=${skuId} AND supplierUid=${supplierUid}
	</update>
</mapper>